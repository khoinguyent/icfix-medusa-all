import{I as H}from"./chunk-JHATTPS3-DKo14Q46.js";import{D as O}from"./chunk-IM74HYR5-DAdRERhP.js";import{D as $,d as L,a as Q}from"./chunk-53RYGJCD-BrX0HYKM.js";import{c as N}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as U}from"./chunk-6HTZNHPT-DLRIMXAt.js";import{R as d,u as Y}from"./chunk-4TC5YS65-h6xMujeu.js";import{af as j,ah as R,as as A,at as J,ai as F,ak as V,b as k,ac as W,eb as X,db as Z,j as t,r as z,am as ee,an as te,aU as se,t as P,B as K}from"./index-DfnPleOL.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./_isIndex-DbDoII3v.js";var v=Q(),ne=(o=[])=>{const{t:i}=k();return z.useMemo(()=>[v.column({id:"title",name:"Title",header:"Title",cell:s=>{const n=s.row.original;return t.jsx(L,{context:s,color:"normal",children:t.jsx("span",{title:n.title||void 0,children:n.title||"-"})})},disableHiding:!0}),v.column({id:"sku",name:"SKU",header:"SKU",cell:s=>{const n=s.row.original;return t.jsx(L,{context:s,color:"normal",children:t.jsx("span",{title:n.sku||void 0,children:n.sku||"-"})})},disableHiding:!0}),...o.map(s=>v.column({id:`location_${s.id}`,name:s.name,header:s.name,field:n=>`inventory_items.${n.row.original.id}.locations.${s.id}`,type:"togglable-number",cell:n=>t.jsx(O,{context:n,disabledToggleTooltip:i("inventory.stock.disabledToggleTooltip")})}))],[o,i])},oe=j({id:R().optional(),quantity:A([J(),R()]),checked:F(),disabledToggle:F()}),ie=V(oe),ae=j({locations:ie}),re=j({inventory_items:V(ae)}),ce=({items:o,locations:i})=>{const{t:s}=k(),{setCloseOnEscape:n,handleSuccess:u}=Y(),r=z.useRef(M(o,i));console.log("initialValues",r.current);const c=ee({defaultValues:M(o,i),resolver:te(re)}),e=ne(i),{mutateAsync:m,isPending:h}=se(),g=c.handleSubmit(async p=>{var x,b,_,S,T,I,q,C,E,w;const l={create:[],update:[],delete:[],force:!0};for(const[y,B]of Object.entries(p.inventory_items))for(const[f,a]of Object.entries(B.locations)){if(a.id)if(((T=(S=(_=(b=(x=r.current)==null?void 0:x.inventory_items)==null?void 0:b[y])==null?void 0:_.locations)==null?void 0:S[f])==null?void 0:T.checked)&&!a.checked)l.delete.push(a.id);else{const D=a.quantity!==""?N(a.quantity):0,G=(w=(E=(C=(q=(I=r.current)==null?void 0:I.inventory_items)==null?void 0:q[y])==null?void 0:C.locations)==null?void 0:E[f])==null?void 0:w.quantity;D!==G&&l.update.push({id:a.id,inventory_item_id:y,location_id:f,stocked_quantity:D})}!a.id&&a.quantity!==""&&l.create.push({inventory_item_id:y,location_id:f,stocked_quantity:N(a.quantity)})}await m(l,{onSuccess:()=>{P.success(s("inventory.stock.successToast")),u()},onError:y=>{P.error(y.message)}})});return t.jsx(d.Form,{form:c,children:t.jsxs(U,{onSubmit:g,className:"flex size-full flex-col",children:[t.jsx(d.Header,{}),t.jsx(d.Body,{className:"size-full flex-1 overflow-y-auto",children:t.jsx($,{columns:e,data:o,state:c,onEditingChange:p=>{n(!p)}})}),t.jsx(d.Footer,{children:t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx(d.Close,{asChild:!0,children:t.jsx(K,{variant:"secondary",size:"small",type:"button",children:s("actions.cancel")})}),t.jsx(K,{type:"submit",size:"small",isLoading:h,children:s("actions.save")})]})})]})})};function M(o,i){return{inventory_items:o.reduce((s,n)=>{const u=i.reduce((r,c)=>{var m;const e=(m=n.location_levels)==null?void 0:m.find(h=>h.location_id===c.id);return r[c.id]={id:e==null?void 0:e.id,quantity:typeof(e==null?void 0:e.stocked_quantity)=="number"?e==null?void 0:e.stocked_quantity:"",checked:!!e,disabledToggle:((e==null?void 0:e.incoming_quantity)||0)>0||((e==null?void 0:e.reserved_quantity)||0)>0},r},{});return s[n.id]={locations:u},s},{})}}var je=()=>{var l;const{t:o}=k(),[i]=W(),s=((l=i.get(H))==null?void 0:l.split(","))||void 0,{inventory_items:n,isPending:u,isError:r,error:c}=X({id:s}),{stock_locations:e,isPending:m,isError:h,error:g}=Z({limit:9999,fields:"id,name"}),p=!u&&!!n&&!m&&!!e;if(r)throw c;if(h)throw g;return t.jsxs(d,{children:[t.jsx(d.Title,{asChild:!0,children:t.jsx("span",{className:"sr-only",children:o("inventory.stock.title")})}),t.jsx(d.Description,{asChild:!0,children:t.jsx("span",{className:"sr-only",children:o("inventory.stock.description")})}),p&&t.jsx(ce,{items:n,locations:e})]})};export{je as Component};
